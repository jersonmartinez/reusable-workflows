name: Setup Dependabot

on:
  workflow_call:
    inputs:
      ecosystems:
        required: true
        type: string
        description: 'JSON con configuraciones de ecosistemas'

      schedule:
        required: false
        type: string
        default: 'weekly'
        description: 'Frecuencia de actualizaciones (daily, weekly, monthly)'

      pr_limit:
        required: false
        type: number
        default: 5
        description: 'MÃ¡ximo de PRs abiertos simultÃ¡neamente'

      target_branch:
        required: false
        type: string
        default: ''
        description: 'Rama objetivo para PRs (vacÃ­o = rama predeterminada)'

jobs:
  configure:
    name: Configuring
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
      pull-requests: read

    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Validate Labels
        id: validate_labels
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cat > /tmp/validate_labels.py << 'SCRIPT_EOF'
          import json, os, subprocess, sys
          from collections import defaultdict

          repo = os.getenv('GITHUB_REPOSITORY')

          try:
              result = subprocess.run(
                  ['gh', 'label', 'list', '--repo', repo, '--json', 'name,color,description', '--limit', '1000'],
                  capture_output=True, text=True, check=True
              )
              labels_data = json.loads(result.stdout)
              existing_labels = {label['name'].lower(): label for label in labels_data}
          except Exception as e:
              print(f"::error::No se pudieron obtener los labels: {e}")
              existing_labels = {}

          try:
              ecosystems = json.loads('''${{ inputs.ecosystems }}''')
          except json.JSONDecodeError as e:
              print(f"::error::Error al parsear ecosistemas: {e}")
              sys.exit(1)

          missing_by_ecosystem = defaultdict(list)
          valid_by_ecosystem = defaultdict(list)
          all_missing = set()

          for eco in ecosystems:
              labels = [l.strip() for l in eco.get('labels', '').split(',') if l.strip()]
              for label in labels:
                  if label.lower() in existing_labels:
                      valid_by_ecosystem[f"{eco['ecosystem']}|{eco['directory']}"].append(label)
                  else:
                      missing_by_ecosystem[f"{eco['ecosystem']}|{eco['directory']}"].append(label)
                      all_missing.add(label)

          # Generar outputs
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"missing_labels={','.join(sorted(all_missing))}\n")
              f.write(f"missing_count={len(all_missing)}\n")
              f.write(f"valid_count={sum(len(v) for v in valid_by_ecosystem.values())}\n")
              f.write(f"has_missing={'true' if all_missing else 'false'}\n")

          # Guardar datos para el summary
          with open('/tmp/validation_data.json', 'w') as f:
              json.dump({
                  'missing_by_ecosystem': dict(missing_by_ecosystem),
                  'valid_by_ecosystem': dict(valid_by_ecosystem),
                  'existing_labels': existing_labels
              }, f)

          if all_missing:
              print(f"::warning title=Labels Faltantes::Se encontraron {len(all_missing)} labels sin configurar")
          else:
              print("::notice title=ValidaciÃ³n Exitosa::Todos los labels estÃ¡n configurados correctamente")
          SCRIPT_EOF

          python3 /tmp/validate_labels.py

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install PyYAML
        run: pip install pyyaml

      - name: ğŸ“ Generate Dependabot Config
        run: |
          cat > /tmp/generate_config.py << 'SCRIPT_EOF'
          import json, os, sys

          try:
              ecosystems = json.loads('''${{ inputs.ecosystems }}''')
          except json.JSONDecodeError as e:
              print(f"::error::JSON invÃ¡lido: {e}")
              sys.exit(1)

          schedule = '${{ inputs.schedule }}'
          pr_limit = ${{ inputs.pr_limit }}
          target_branch = '${{ inputs.target_branch }}'

          config = {'version': 2, 'updates': []}

          for eco in ecosystems:
              update = {
                  'package-ecosystem': eco['ecosystem'],
                  'directory': eco['directory'],
                  'schedule': {'interval': schedule},
                  'open-pull-requests-limit': eco.get('pr_limit', pr_limit)
              }

              if target_branch:
                  update['target-branch'] = target_branch

              labels = [l.strip() for l in eco.get('labels', '').split(',') if l.strip()]
              if labels:
                  update['labels'] = labels

              prefix = eco.get('prefix', '').strip()
              if prefix:
                  update['commit-message'] = {'prefix': prefix}

              config['updates'].append(update)

          import yaml
          os.makedirs('.github', exist_ok=True)

          # Generar YAML con indentaciÃ³n correcta
          with open('.github/dependabot.yml', 'w') as f:
              yaml.dump(config, f, sort_keys=False, default_flow_style=False, indent=2)

          print("âœ… ConfiguraciÃ³n generada exitosamente")

          # Verificar el archivo generado
          with open('.github/dependabot.yml', 'r') as f:
              content = f.read()
              print("\nğŸ“„ Contenido generado:")
              print(content)
          SCRIPT_EOF

          python3 /tmp/generate_config.py

      - name: ğŸ’¾ Commit Changes
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet .github/dependabot.yml; then
            echo "status=unchanged" >> $GITHUB_OUTPUT
            echo "::notice::No hay cambios en la configuraciÃ³n"
          else
            git add .github/dependabot.yml
            git commit -m "chore(deps): update dependabot configuration [skip ci]"
            git push
            echo "status=updated" >> $GITHUB_OUTPUT
            echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
            echo "::notice::ConfiguraciÃ³n actualizada y commitada"
          fi

      - name: ğŸ” Check Dependabot PRs
        id: check_prs
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Esperar un momento para que GitHub sincronice
          sleep 3

          # Obtener PRs de Dependabot
          prs_json=$(gh pr list \
            --repo ${{ github.repository }} \
            --author "app/dependabot" \
            --state open \
            --json number,title,createdAt,labels,updatedAt \
            --limit 50 2>/dev/null || echo '[]')

          echo "prs_data<<EOF" >> $GITHUB_OUTPUT
          echo "$prs_json" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          prs_count=$(echo "$prs_json" | jq '. | length' 2>/dev/null || echo "0")
          echo "prs_count=$prs_count" >> $GITHUB_OUTPUT

          echo "::notice::Se encontraron $prs_count PRs de Dependabot"

      - name: ğŸ“Š Generate Summary
        if: always()
        env:
          ECOSYSTEMS_JSON: ${{ inputs.ecosystems }}
          DEFAULT_PR_LIMIT: ${{ inputs.pr_limit }}
          COMMIT_STATUS: ${{ steps.commit.outputs.status }}
          COMMIT_SHA: ${{ steps.commit.outputs.sha }}
          PRS_DATA: ${{ steps.check_prs.outputs.prs_data }}
          PRS_COUNT: ${{ steps.check_prs.outputs.prs_count }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
        run: |
          cat > /tmp/generate_summary.py << 'SCRIPT_EOF'
          import json, os, sys
          from datetime import datetime

          repo = os.getenv('GITHUB_REPOSITORY')
          server_url = os.getenv('GITHUB_SERVER_URL', 'https://github.com')
          run_id = os.getenv('GITHUB_RUN_ID')
          default_pr_limit = os.getenv('DEFAULT_PR_LIMIT', '5')

          # Cargar datos de validaciÃ³n
          try:
              with open('/tmp/validation_data.json', 'r') as f:
                  validation = json.load(f)
          except:
              validation = {'missing_by_ecosystem': {}, 'valid_by_ecosystem': {}, 'existing_labels': {}}

          # Parsear ecosistemas
          try:
              ecosystems = json.loads(os.getenv('ECOSYSTEMS_JSON', '[]'))
          except:
              ecosystems = []

          # Parsear PRs
          prs_count = int(os.getenv('PRS_COUNT', '0'))
          try:
              prs_raw = os.getenv('PRS_DATA', '[]')
              prs_data = json.loads(prs_raw) if prs_raw and prs_raw.strip() != '' else []
          except Exception as e:
              print(f"::debug::Error parseando PRs: {e}")
              prs_data = []

          commit_status = os.getenv('COMMIT_STATUS', 'unknown')
          commit_sha = os.getenv('COMMIT_SHA', 'N/A')

          # Generar summary
          summary = []

          # Header
          summary.append("# ğŸ¤– ConfiguraciÃ³n de Dependabot\n\n")

          # Estado del commit con enlace
          if commit_status == 'updated':
              commit_url = f"{server_url}/{repo}/commit/{commit_sha}"
              summary.append(f"âœ… **ConfiguraciÃ³n actualizada** â€¢ Commit: [ğŸ“ `{commit_sha[:7]}`]({commit_url})\n\n")
          else:
              summary.append("â„¹ï¸ **Sin cambios** â€¢ La configuraciÃ³n estÃ¡ actualizada\n\n")

          # Resumen rÃ¡pido en tabla compacta
          total_labels = sum(len(v) for v in validation['valid_by_ecosystem'].values())
          missing_count = sum(len(v) for v in validation['missing_by_ecosystem'].values())
          
          summary.append("### ğŸ“Š Resumen Ejecutivo\n\n")
          summary.append("| ğŸ”§ Ecosistemas | ğŸ·ï¸ Labels VÃ¡lidos | âš ï¸ Labels Faltantes | ğŸ”„ PRs Activos |\n")
          summary.append("|:--------------:|:-----------------:|:-------------------:|:--------------:|\n")
          summary.append(f"| **{len(ecosystems)}** | **{total_labels}** | **{missing_count}** | **{prs_count}** |\n\n")

          # Tabla consolidada de ecosistemas con ancho fijo
          summary.append("<details open>\n")
          summary.append("<summary><h3>ğŸ“¦ Ecosistemas Configurados</h3></summary>\n\n")
          summary.append("<table style='width:100%'>\n")
          summary.append("<colgroup>\n")
          summary.append("<col style='width:12%'>\n")  # Ecosistema
          summary.append("<col style='width:12%'>\n")  # Directorio
          summary.append("<col style='width:10%'>\n")  # Prefijo
          summary.append("<col style='width:8%'>\n")   # PR Limit
          summary.append("<col style='width:28%'>\n")  # Labels VÃ¡lidos
          summary.append("<col style='width:30%'>\n")  # Labels Faltantes
          summary.append("</colgroup>\n")
          summary.append("<thead>\n")
          summary.append("<tr>\n")
          summary.append("<th>Ecosistema</th>\n")
          summary.append("<th>Directorio</th>\n")
          summary.append("<th>Prefijo</th>\n")
          summary.append("<th>PR Limit</th>\n")
          summary.append("<th>Labels VÃ¡lidos</th>\n")
          summary.append("<th>Labels Faltantes</th>\n")
          summary.append("</tr>\n")
          summary.append("</thead>\n")
          summary.append("<tbody>\n")

          for eco in ecosystems:
              eco_key = f"{eco['ecosystem']}|{eco['directory']}"
              valid_labels = validation['valid_by_ecosystem'].get(eco_key, [])
              missing_labels = validation['missing_by_ecosystem'].get(eco_key, [])
              existing_labels = validation['existing_labels']

              # Generar badges inline para labels vÃ¡lidos
              valid_badges = []
              for label in valid_labels:
                  label_data = existing_labels.get(label.lower(), {})
                  color = label_data.get('color', '0366d6')
                  label_encoded = label.replace(" ", "%20").replace("-", "--")
                  badge_url = f"https://img.shields.io/badge/-{label_encoded}-{color}?style=flat-square"
                  link = f'{server_url}/{repo}/labels/{label.replace(" ", "%20")}'
                  valid_badges.append(f'<a href="{link}"><img src="{badge_url}" alt="{label}" style="margin:2px"/></a>')

              # Labels faltantes inline separados por espacios
              missing_badges = [f'<code style="white-space:nowrap">{label}</code>' for label in missing_labels]

              eco_pr_limit = eco.get('pr_limit', default_pr_limit)

              summary.append("<tr>\n")
              summary.append(f"<td><code>{eco['ecosystem']}</code></td>\n")
              summary.append(f"<td><code>{eco['directory']}</code></td>\n")
              summary.append(f"<td><code>{eco.get('prefix', '-')}</code></td>\n")
              summary.append(f"<td align='center'><b>{eco_pr_limit}</b></td>\n")
              summary.append(f"<td style='white-space:nowrap'>{' '.join(valid_badges) if valid_badges else 'â–'}</td>\n")
              summary.append(f"<td>{' '.join(missing_badges) if missing_badges else 'âœ…'}</td>\n")
              summary.append("</tr>\n")

          summary.append("</tbody>\n")
          summary.append("</table>\n\n")

          # Warning si hay labels faltantes
          all_missing = set()
          for labels in validation['missing_by_ecosystem'].values():
              all_missing.update(labels)

          if all_missing:
              labels_create_url = f"{server_url}/{repo}/labels/new"
              summary.append(f"> âš ï¸ **AcciÃ³n Recomendada:** Algunos labels no existen. ")
              summary.append(f"<a href='{labels_create_url}'>ğŸ·ï¸ <b>Crear labels faltantes</b></a> ")
              summary.append("o ajustar la configuraciÃ³n.\n\n")

          summary.append("</details>\n\n")

          # PRs Activos en acordeÃ³n
          if prs_count > 0:
              summary.append("<details>\n")
              summary.append(f"<summary><h3>ğŸ”„ Pull Requests de Dependabot ({prs_count})</h3></summary>\n\n")
              summary.append("<table>\n")
              summary.append("<tr><th>#</th><th>TÃ­tulo</th><th>Labels</th><th>Actualizado</th></tr>\n")

              for pr in prs_data[:15]:
                  pr_number = pr['number']
                  pr_title = pr['title'][:70] + ('...' if len(pr['title']) > 70 else '')
                  pr_labels = ', '.join([f"`{l['name']}`" for l in pr.get('labels', [])[:3]])
                  pr_date = pr.get('updatedAt', pr.get('createdAt', 'N/A'))[:10]
                  pr_link = f"{server_url}/{repo}/pull/{pr_number}"

                  summary.append("<tr>\n")
                  summary.append(f"<td><a href='{pr_link}'><b>#{pr_number}</b></a></td>\n")
                  summary.append(f"<td>{pr_title}</td>\n")
                  summary.append(f"<td>{pr_labels if pr_labels else 'â–'}</td>\n")
                  summary.append(f"<td>{pr_date}</td>\n")
                  summary.append("</tr>\n")

              summary.append("</table>\n\n")

              if prs_count > 15:
                  prs_url = f"{server_url}/{repo}/pulls?q=is%3Apr+is%3Aopen+author%3Aapp%2Fdependabot"
                  summary.append(f"> <a href='{prs_url}'>ğŸ“‹ <b>Ver todos los PRs ({prs_count})</b></a>\n\n")
              
              summary.append("</details>\n\n")
          else:
              summary.append("<details>\n")
              summary.append("<summary><h3>ğŸ”„ Pull Requests de Dependabot</h3></summary>\n\n")
              summary.append("> â„¹ï¸ No hay PRs activos de Dependabot en este momento.\n\n")
              summary.append("</details>\n\n")

          # Enlaces Ãºtiles en acordeÃ³n
          summary.append("<details>\n")
          summary.append("<summary><h3>ğŸ”— Enlaces Ãštiles</h3></summary>\n\n")
          
          config_url = f"{server_url}/{repo}/blob/main/.github/dependabot.yml"
          summary.append(f"- ğŸ“ <a href='{config_url}'><b>Ver ConfiguraciÃ³n</b></a> â€” Archivo dependabot.yml generado\n")
          
          security_url = f"{server_url}/{repo}/settings/security_analysis"
          summary.append(f"- ğŸ›¡ï¸ <a href='{security_url}'><b>Security Settings</b></a> â€” Configurar anÃ¡lisis de seguridad\n")
          
          insights_url = f"{server_url}/{repo}/network/dependencies"
          summary.append(f"- ğŸ“Š <a href='{insights_url}'><b>Dependency Graph</b></a> â€” Visualizar dependencias\n")
          
          labels_url = f"{server_url}/{repo}/labels"
          summary.append(f"- ğŸ·ï¸ <a href='{labels_url}'><b>Gestionar Labels</b></a> â€” Crear o editar labels\n")
          
          prs_url = f"{server_url}/{repo}/pulls?q=is%3Apr+author%3Aapp%2Fdependabot"
          summary.append(f"- ğŸ”„ <a href='{prs_url}'><b>PRs de Dependabot</b></a> â€” Ver Pull Requests activos\n")
          
          advisories_url = f"{server_url}/{repo}/security/dependabot"
          summary.append(f"- ğŸš¨ <a href='{advisories_url}'><b>Security Alerts</b></a> â€” Revisar alertas de seguridad\n\n")
          
          summary.append("</details>\n\n")

          # InformaciÃ³n del Workflow en acordeÃ³n
          summary.append("<details>\n")
          summary.append("<summary><b>ğŸ“š Sobre el Workflow Reusable</b></summary>\n\n")

          summary.append("#### âœ… CaracterÃ­sticas\n\n")
          summary.append("- ğŸ” ValidaciÃ³n automÃ¡tica de labels\n")
          summary.append("- ğŸ“Š Summary con diseÃ±o consolidado y responsive\n")
          summary.append("- ğŸ·ï¸ Badges con colores del repositorio\n")
          summary.append("- ğŸ”— Enlaces directos a recursos\n")
          summary.append("- ğŸ”„ DetecciÃ³n de PRs existentes\n")
          summary.append("- ğŸ“ ConfiguraciÃ³n personalizable\n")
          summary.append("- ğŸ¯ Rama objetivo configurable\n\n")

          summary.append("#### ğŸ”® Mejoras Futuras\n\n")
          summary.append("- ğŸ”” Notificaciones a Slack/Discord\n")
          summary.append("- ğŸ“ˆ Matriz de compatibilidad\n")
          summary.append("- ğŸ›¡ï¸ IntegraciÃ³n con Security Advisories\n")
          summary.append("- ğŸ“Š Dashboard centralizado\n")
          summary.append("- ğŸ” AnÃ¡lisis predictivo de impacto\n\n")

          summary.append("</details>\n\n")

          # Footer
          timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')
          workflow_url = f"{server_url}/jersonmartinez/reusable-workflows"
          summary.append(f"<sub>ğŸ¤– Generado por <a href='{workflow_url}'><b>Reusable Workflows</b></a> â€¢ {timestamp}</sub>\n")

          # Escribir summary
          with open(os.environ['GITHUB_STEP_SUMMARY'], 'w') as f:
              f.write(''.join(summary))

          print("âœ… Summary generado correctamente")
          print(f"ğŸ“Š PRs detectados: {prs_count}")
          print(f"ğŸ“¦ Ecosistemas: {len(ecosystems)}")
          SCRIPT_EOF

          python3 /tmp/generate_summary.py
