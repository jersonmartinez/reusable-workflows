name: Reusable Dependabot Workflow

# Documentaci칩n del Workflow
# =========================
# Este workflow permite automatizar la gesti칩n de dependencias utilizando Dependabot.
# Caracter칤sticas principales:
# - Configurable para diferentes ecosistemas (npm, pip, maven, etc.)
# - Puede ejecutarse bajo demanda o con programaci칩n
# - Configurable para auto-aprobar y auto-fusionar actualizaciones
# - Simple y directo para integrarse en pipelines de CI/CD

on:
  workflow_call:
    inputs:
      # Par치metros de configuraci칩n general
      package_ecosystem:
        required: true
        type: string
        description: 'Ecosistema de paquetes (npm, pip, maven, docker, etc.)'
      directory:
        required: true
        type: string
        description: 'Directorio donde se encuentra el archivo de dependencias'
      dependency_file_path:
        required: false
        type: string
        default: ''
        description: 'Ruta exacta del archivo de dependencias relativa al repositorio. Si se omite, se detecta autom치ticamente para ecosistemas conocidos'
      schedule_interval:
        required: false
        type: string
        default: ''
        description: 'Frecuencia de verificaci칩n (daily, weekly, monthly). Si est치 vac칤o, se ejecuta bajo demanda'
      open_pull_requests_limit:
        required: false
        type: number
        default: 10
        description: 'L칤mite de PRs abiertos simult치neamente'
      
      # Par치metros para auto-aprobaci칩n y auto-fusi칩n
      auto_approve:
        required: false
        type: boolean
        default: false
        description: 'Aprobar autom치ticamente PRs de Dependabot'
      auto_merge:
        required: false
        type: boolean
        default: false
        description: 'Fusionar autom치ticamente PRs de Dependabot'
      auto_merge_label:
        required: false
        type: string
        default: 'dependencies'
        description: 'Etiqueta que deben tener los PRs de Dependabot para ser auto-fusionados. Dejar vac칤o para no filtrar por etiqueta'
      
      # Par치metros para configuraci칩n de versiones
      allow_major_versions:
        required: false
        type: boolean
        default: false
        description: 'Permitir actualizaciones de versiones mayores'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Dependabot configuration
        id: setup_dependabot_config
        run: |
          mkdir -p .github
          
          if [ -n "${{ inputs.schedule_interval }}" ]; then
            cat > .github/dependabot.yml << EOF
          version: 2
          updates:
            - package-ecosystem: "${{ inputs.package_ecosystem }}"
              directory: "${{ inputs.directory }}"
              schedule:
                interval: "${{ inputs.schedule_interval }}"
              open-pull-requests-limit: ${{ inputs.open_pull_requests_limit }}
          EOF

            if [ "${{ inputs.allow_major_versions }}" != 'true' ]; then
              cat >> .github/dependabot.yml << 'EOF'
              ignore:
                - dependency-name: "*"
                  update-types:
                    - "version-update:semver-major"
          EOF
            fi

            echo "config_written=true" >> "$GITHUB_OUTPUT"
          else
            echo "Se omiti칩 la configuraci칩n de dependabot.yml para ejecuciones bajo demanda" >> "$GITHUB_STEP_SUMMARY"
            echo "config_written=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolver archivo de dependencias
        if: ${{ inputs.schedule_interval == '' }}
        id: manifest
        env:
          INPUT_MANIFEST: ${{ inputs.dependency_file_path }}
          PACKAGE_ECOSYSTEM: ${{ inputs.package_ecosystem }}
          DEP_DIRECTORY: ${{ inputs.directory }}
        run: |
          set -euo pipefail

          manifest="$INPUT_MANIFEST"

          if [ -z "$manifest" ]; then
            case "$PACKAGE_ECOSYSTEM" in
              npm|yarn|pnpm)
                manifest="package.json"
                ;;
              pip)
                manifest="requirements.txt"
                ;;
              poetry)
                manifest="pyproject.toml"
                ;;
              maven)
                manifest="pom.xml"
                ;;
              gradle)
                manifest="build.gradle"
                ;;
              gradle-kotlin)
                manifest="build.gradle.kts"
                ;;
              cargo)
                manifest="Cargo.toml"
                ;;
              composer)
                manifest="composer.json"
                ;;
              gomod)
                manifest="go.mod"
                ;;
              bundler)
                manifest="Gemfile"
                ;;
              docker)
                manifest="Dockerfile"
                ;;
              github-actions)
                manifest=".github/workflows"
                ;;
              *)
                echo "No se pudo determinar el archivo de dependencias para el ecosistema '$PACKAGE_ECOSYSTEM'." >&2
                echo "Proporciona 'dependency_file_path' al invocar el workflow." >&2
                exit 1
                ;;
            esac
          fi

          dir="$DEP_DIRECTORY"
          if [ "$dir" = "/" ]; then
            dir=""
          else
            dir="${dir#/}"
            dir="${dir%/}"
          fi

          if [ -n "$dir" ]; then
            dependency_path="$dir/$manifest"
          else
            dependency_path="$manifest"
          fi

          echo "Archivo de dependencias resuelto: $dependency_path" >> "$GITHUB_STEP_SUMMARY"
          echo "dependency_file=$dependency_path" >> "$GITHUB_OUTPUT"
      
      # Si no hay schedule_interval, ejecutar verificaci칩n inmediata
      - name: Run immediate dependency check
        if: ${{ inputs.schedule_interval == '' }}
        run: |
          echo "Ejecutando verificaci칩n inmediata de dependencias"
          # Usar GitHub CLI para verificar dependencias
          gh api -X POST /repos/${{ github.repository }}/dependabot/scans \
            -f dependency-file-path="${{ steps.manifest.outputs.dependency_file }}" \
            -f package-ecosystem="${{ inputs.package_ecosystem }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Commit Dependabot configuration
        if: ${{ steps.setup_dependabot_config.outputs.config_written == 'true' }}
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: Configure Dependabot"
          file_pattern: .github/dependabot.yml

      - name: Resumen del workflow
        if: ${{ always() }}
        env:
          INPUT_SCHEDULE_INTERVAL: ${{ inputs.schedule_interval }}
          INPUT_PACKAGE_ECOSYSTEM: ${{ inputs.package_ecosystem }}
          INPUT_DIRECTORY: ${{ inputs.directory }}
          INPUT_DEPENDENCY_FILE: ${{ steps.manifest.outputs.dependency_file }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mode="Programado (configuraci칩n escrita)"
          archivo="Generaci칩n de .github/dependabot.yml"

          if [ -z "$INPUT_SCHEDULE_INTERVAL" ]; then
            mode="Bajo demanda (escaneo inmediato)"
            archivo="${INPUT_DEPENDENCY_FILE:-No determinado}"
          fi

          {
            echo "## 游 Resumen de Dependabot"
            echo ""
            echo "| 游빌 Clave | Valor |"
            echo "| --- | --- |"
            echo "| Repositorio | \`${GITHUB_REPOSITORY}\` |"
            echo "| Directorio | \`${INPUT_DIRECTORY}\` |"
            echo "| Ecosistema | \`${INPUT_PACKAGE_ECOSYSTEM}\` |"
            echo "| Modo | ${mode} |"
            echo "| Archivo evaluado | \`${archivo}\` |"
          } >> "$GITHUB_STEP_SUMMARY"

          pr_table=$(gh pr list --repo "$GITHUB_REPOSITORY" --state open --search "author:app/dependabot" --limit 20 --json number,title,url,baseRefName --jq '
            if length == 0 then
              ""
            else
              (["| N칰mero | T칤tulo | Rama base | URL |","| --- | --- | --- | --- |"] +
                (map("| #" + (.number|tostring) + " | " + (.title|gsub("\\|";"\\|")) + " | " + .baseRefName + " | " + .url + " |")))
                | join("\n")
            end' )

          {
            echo ""
            if [ -z "$pr_table" ]; then
              echo "_No se encontraron PRs abiertos de Dependabot en este momento._"
            else
              echo "### 游닓 PRs abiertos de Dependabot"
              echo ""
              echo "$pr_table"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # Este job se ejecuta cuando hay PRs de Dependabot y auto_approve est치 habilitado
  auto-approve-dependabot:
    needs: check-dependencies
    if: ${{ inputs.auto_approve == true }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Auto-approve Dependabot PRs
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: "Auto-aprobado por el workflow de Dependabot"

  # Este job se ejecuta cuando hay PRs de Dependabot y auto_merge est치 habilitado
  auto-merge-dependabot:
    needs: [check-dependencies]
    if: ${{ inputs.auto_merge == true }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Auto-merge Dependabot PRs
        run: |
          set -euo pipefail

          label='${{ inputs.auto_merge_label }}'
          search_query="author:app/dependabot"
          if [ -n "$label" ]; then
            search_query="$search_query label:$label"
          fi

          prs=$(gh pr list --repo "${{ github.repository }}" --state open --search "$search_query" --json number --jq '.[].number')

          if [ -z "$prs" ]; then
            echo "No se encontraron PRs de Dependabot para fusionar"
            exit 0
          fi

          while IFS= read -r pr_number; do
            echo "Auto-merge del PR #$pr_number"
            gh pr merge "$pr_number" --auto --merge --repo "${{ github.repository }}"
          done <<< "$prs"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}