Run cat > /tmp/detect_prs.py << 'SCRIPT_EOF'
  cat > /tmp/detect_prs.py << 'SCRIPT_EOF'
  import json, os, subprocess, time
  
  wait_minutes = int(os.getenv('WAIT_MINUTES', '10'))
  repo = os.getenv('GITHUB_REPOSITORY')
  
  def list_prs():
      try:
          args = [
              'gh','pr','list',
              '--repo', repo,
              '--state','open',
              '--json','number,title,url,labels,createdAt,headRefName',
              '--search','author:dependabot'
          ]
          result = subprocess.run(args, capture_output=True, text=True)
          if result.returncode == 0:
              return json.loads(result.stdout)
          return []
      except Exception:
          return []
  
  prs = list_prs()
  deadline = time.time() + wait_minutes*60
  
  while len(prs) == 0 and time.time() < deadline:
      time.sleep(30)
      prs = list_prs()
  
  with open(os.environ['GITHUB_OUTPUT'],'a') as f:
      f.write('prs_data<<EOF\n')
      f.write(json.dumps(prs))
      f.write('\nEOF\n')
      f.write(f"prs_count={len(prs)}\n")
  
  print(f"ğŸ“Š PRs detectados: {len(prs)}")
  SCRIPT_EOF
  
  python3 /tmp/detect_prs.py
  shell: /usr/bin/bash -e {0}
  env:
    RUN_STARTED_AT: 2025-11-18T00:09:12Z
    GH_TOKEN: ***
    WAIT_MINUTES: 10
  
ğŸ“Š PRs detectados: 0
0s
Run cat > /tmp/create_issue.py << 'SCRIPT_EOF'
  
ğŸ§¾ Issue creado: N/A
0s
0s
Run cat > /tmp/generate_summary.py << 'SCRIPT_EOF'
  cat > /tmp/generate_summary.py << 'SCRIPT_EOF'
  import json, os
  from datetime import datetime
  
  repo = os.getenv('GITHUB_REPOSITORY')
  server_url = os.getenv('GITHUB_SERVER_URL', 'https://github.com')
  changed = os.getenv('CHANGED', 'false')
  commit_sha = os.getenv('COMMIT_SHA', '')
  missing_count = int(os.getenv('MISSING_COUNT', '0'))
  valid_count = int(os.getenv('VALID_COUNT', '0'))
  
  # Cargar datos de validaciÃ³n
  try:
      with open('/tmp/validation_data.json', 'r') as f:
          validation_data = json.load(f)
      missing_by_ecosystem = validation_data['missing_by_ecosystem']
      valid_by_ecosystem = validation_data['valid_by_ecosystem']
      existing_labels = validation_data['existing_labels']
  except Exception as e:
      print(f"::error::No se pudo cargar validation_data.json: {e}")
      missing_by_ecosystem = {}
      valid_by_ecosystem = {}
      existing_labels = {}
  
  # Cargar ecosistemas originales
  try:
      ecosystems = json.loads('''[
    {"ecosystem":"pip","directory":"/api","labels":"dependencies,ğŸš€ Deploy,api","prefix":"chore","pr_limit":5},
    {"ecosystem":"pip","directory":"/app","labels":"dependencies,python,app","prefix":"chore","pr_limit":5},
    {"ecosystem":"docker","directory":"/","labels":"DevOps,dependencies,docker","prefix":"build"},
    {"ecosystem":"github-actions","directory":"/","labels":"dependencies,DevOps,ci","prefix":"ci","pr_limit":8}
  ]''')
  except:
      ecosystems = []
  
  # Cargar PRs
  try:
      prs_raw = os.getenv('PRS_DATA', '[]')
      prs_data = json.loads(prs_raw) if prs_raw and prs_raw.strip() != '' else []
  except Exception as e:
      print(f"::debug::Error parseando PRs: {e}")
      prs_data = []
  
  prs_count = int(os.getenv('PRS_COUNT', '0'))
  
  summary = []
  
  # Header
  summary.append("# ğŸ¤– ConfiguraciÃ³n de Dependabot\n\n")
  
  # Estado
  if changed == 'true' and commit_sha:
      commit_url = f"{server_url}/{repo}/commit/{commit_sha}"
      summary.append(f"âœ… **ConfiguraciÃ³n actualizada** â€¢ Commit: [ğŸ“ `{commit_sha[:7]}`]({commit_url})\n\n")
  else:
      summary.append("â„¹ï¸ **Sin cambios** â€¢ La configuraciÃ³n estÃ¡ actualizada\n\n")
  
  # Resumen ejecutivo
  total_ecosystems = len(ecosystems)
  total_labels = valid_count + missing_count
  
  summary.append("## ğŸ“Š Resumen Ejecutivo\n\n")
  summary.append("| ğŸ”§ Ecosistemas | ğŸ·ï¸ Labels VÃ¡lidos | âš ï¸ Labels Faltantes | ğŸ”„ PRs Activos |\n")
  summary.append("|:--------------:|:-----------------:|:-------------------:|:--------------:|\n")
  summary.append(f"| **{total_ecosystems}** | **{valid_count}** | **{missing_count}** | **{prs_count}** |\n\n")
  
  # Tabla de ecosistemas
  summary.append("<details open>\n")
  summary.append("<summary><h2>ğŸ“¦ Ecosistemas Configurados</h2></summary>\n\n")
  summary.append("<table>\n")
  summary.append("<colgroup>\n")
  summary.append("<col style='width:12%'>\n")
  summary.append("<col style='width:12%'>\n")
  summary.append("<col style='width:10%'>\n")
  summary.append("<col style='width:8%'>\n")
  summary.append("<col style='width:28%'>\n")
  summary.append("<col style='width:30%'>\n")
  summary.append("</colgroup>\n")
  summary.append("<thead>\n")
  summary.append("<tr>\n")
  summary.append("<th>Ecosistema</th>\n")
  summary.append("<th>Directorio</th>\n")
  summary.append("<th>Prefijo</th>\n")
  summary.append("<th>PR Limit</th>\n")
  summary.append("<th>Labels VÃ¡lidos</th>\n")
  summary.append("<th>Labels Faltantes</th>\n")
  summary.append("</tr>\n")
  summary.append("</thead>\n")
  summary.append("<tbody>\n")
  
  for eco in ecosystems:
      eco_key = f"{eco['ecosystem']}|{eco['directory']}"
      
      valid_labels = valid_by_ecosystem.get(eco_key, [])
      missing_labels = missing_by_ecosystem.get(eco_key, [])
  
      valid_badges = []
      for label in valid_labels:
          label_info = existing_labels.get(label.lower(), {})
          color = label_info.get('color', '0366d6')
          valid_badges.append(
              f"<img src='https://img.shields.io/badge/{label.replace('-', '--')}-{color}?style=flat-square' alt='{label}' style='margin:2px'>"
          )
  
      missing_badges = [
          f'<code style="white-space:nowrap">{label}</code>' 
          for label in missing_labels
      ]
  
      summary.append("<tr>\n")
      summary.append(f"<td><code>{eco['ecosystem']}</code></td>\n")
      summary.append(f"<td><code>{eco['directory']}</code></td>\n")
      summary.append(f"<td><code>{eco.get('prefix', '-')}</code></td>\n")
      summary.append(f"<td>{eco.get('pr_limit', '5')}</td>\n")
      summary.append(f"<td>{' '.join(valid_badges) if valid_badges else 'â–'}</td>\n")
      summary.append(f"<td>{' '.join(missing_badges) if missing_badges else 'âœ…'}</td>\n")
      summary.append("</tr>\n")
  
  summary.append("</tbody>\n")
  summary.append("</table>\n\n")
  
  if missing_count > 0:
      labels_url = f"{server_url}/{repo}/labels"
      summary.append(f"> âš ï¸ **AcciÃ³n Recomendada:** Algunos labels no existen. ")
      summary.append(f"<a href='{labels_url}'>ğŸ”§ <b>Crear labels faltantes</b></a> o ajustar la configuraciÃ³n.\n\n")
  
  summary.append("</details>\n\n")
  
  # PRs de Dependabot
  if prs_data and len(prs_data) > 0:
      summary.append("<details>\n")
      summary.append(f"<summary><h2>ğŸ”„ Pull Requests de Dependabot ({min(prs_count, 15)})</h2></summary>\n\n")
  
      summary.append("<table>\n")
      summary.append("<thead>\n")
      summary.append("<tr>\n")
      summary.append("<th>PR</th>\n")
      summary.append("<th>TÃ­tulo</th>\n")
      summary.append("<th>Labels</th>\n")
      summary.append("<th>Creado</th>\n")
      summary.append("</tr>\n")
      summary.append("</thead>\n")
      summary.append("<tbody>\n")
  
      for pr in prs_data[:15]:
          pr_number = pr.get('number', 'N/A')
          pr_url = pr.get('url', '#')
          pr_title = pr.get('title', 'Sin tÃ­tulo')
          pr_labels = ', '.join([l.get('name', '') for l in pr.get('labels', [])])
          pr_created = pr.get('createdAt', '')
          
          try:
              pr_date = datetime.fromisoformat(pr_created.replace('Z', '+00:00')).strftime('%Y-%m-%d')
          except:
              pr_date = 'N/A'
  
          summary.append("<tr>\n")
          summary.append(f"<td><a href='{pr_url}'><b>#{pr_number}</b></a></td>\n")
          summary.append(f"<td>{pr_title}</td>\n")
          summary.append(f"<td>{pr_labels if pr_labels else 'â–'}</td>\n")
          summary.append(f"<td>{pr_date}</td>\n")
          summary.append("</tr>\n")
  
      summary.append("</tbody>\n")
      summary.append("</table>\n\n")
  
      if prs_count > 15:
          prs_url = f"{server_url}/{repo}/pulls?q=is%3Apr+is%3Aopen+author%3Aapp%2Fdependabot"
          summary.append(f"> <a href='{prs_url}'>ğŸ“‹ <b>Ver todos los PRs ({prs_count})</b></a>\n\n")
  
      summary.append("</details>\n\n")
  else:
      summary.append("<details>\n")
      summary.append("<summary><h2>ğŸ”„ Pull Requests de Dependabot</h2></summary>\n\n")
      summary.append("> â„¹ï¸ No hay PRs activos de Dependabot en este momento.\n\n")
      summary.append("</details>\n\n")
  
  issue_url = os.getenv('ISSUE_URL','')
  if issue_url:
      summary.append(f"> ğŸ§¾ <b>Issue de reporte:</b> <a href='{issue_url}'>{issue_url}</a>\n\n")
  
  # Enlaces Ãºtiles
  summary.append("<details>\n")
  summary.append("<summary><h2>ğŸ”— Enlaces Ãštiles</h2></summary>\n\n")
  
  config_url = f"{server_url}/{repo}/blob/main/.github/dependabot.yml"
  summary.append(f"- ğŸ“ <a href='{config_url}'><b>Ver ConfiguraciÃ³n</b></a> â€” Archivo dependabot.yml generado\n")
  
  security_url = f"{server_url}/{repo}/settings/security_analysis"
  summary.append(f"- ğŸ›¡ï¸ <a href='{security_url}'><b>Security Settings</b></a> â€” Configurar anÃ¡lisis de seguridad\n")
  
  insights_url = f"{server_url}/{repo}/network/dependencies"
  summary.append(f"- ğŸ“Š <a href='{insights_url}'><b>Dependency Graph</b></a> â€” Visualizar dependencias\n")
  
  labels_url = f"{server_url}/{repo}/labels"
  summary.append(f"- ğŸ·ï¸ <a href='{labels_url}'><b>Gestionar Labels</b></a> â€” Crear o editar labels\n")
  
  prs_url = f"{server_url}/{repo}/pulls?q=is%3Apr+author%3Aapp%2Fdependabot"
  summary.append(f"- ğŸ”„ <a href='{prs_url}'><b>PRs de Dependabot</b></a> â€” Ver Pull Requests activos\n")
  
  advisories_url = f"{server_url}/{repo}/security/dependabot"
  summary.append(f"- ğŸš¨ <a href='{advisories_url}'><b>Security Alerts</b></a> â€” Revisar alertas de seguridad\n\n")
  
  summary.append("</details>\n\n")
  
  # InformaciÃ³n del workflow
  summary.append("<details>\n")
  summary.append("<summary><b>ğŸ“š Sobre el Workflow Reusable</b></summary>\n\n")
  
  summary.append("#### âœ… CaracterÃ­sticas\n\n")
  summary.append("- ğŸ” ValidaciÃ³n automÃ¡tica de labels\n")
  summary.append("- ğŸ›¡ï¸ Filtrado automÃ¡tico de labels invÃ¡lidos\n")
  summary.append("- ğŸ“Š Summary con diseÃ±o consolidado y responsive\n")
  summary.append("- ğŸ·ï¸ Badges con colores del repositorio\n")
  summary.append("- ğŸ”— Enlaces directos a recursos\n")
  summary.append("- ğŸ”„ DetecciÃ³n de PRs existentes\n")
  summary.append("- ğŸ“ ConfiguraciÃ³n personalizable\n")
  summary.append("- ğŸ¯ Rama objetivo configurable\n\n")
  
  summary.append("#### ğŸ”® Mejoras Futuras\n\n")
  summary.append("- ğŸ”” Notificaciones a Slack/Discord\n")
  summary.append("- ğŸ“ˆ Matriz de compatibilidad\n")
  summary.append("- ğŸ›¡ï¸ IntegraciÃ³n con Security Advisories\n")
  summary.append("- ğŸ“Š Dashboard centralizado\n")
  summary.append("- ğŸ” AnÃ¡lisis predictivo de impacto\n\n")
  
  summary.append("</details>\n\n")
  
  # Footer
  timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')
  workflow_url = f"{server_url}/jersonmartinez/reusable-workflows"
  summary.append(f"<sub>ğŸ¤– Generado por <a href='{workflow_url}'><b>Reusable Workflows</b></a> â€¢ {timestamp}</sub>\n")
  
  # Escribir summary
  with open(os.environ['GITHUB_STEP_SUMMARY'], 'w') as f:
      f.write(''.join(summary))
  
  print("âœ… Summary generado correctamente")
  print(f"ğŸ“Š PRs detectados: {prs_count}")
  print(f"ğŸ“¦ Ecosistemas: {len(ecosystems)}")
  print(f"âœ… Labels vÃ¡lidos: {valid_count}")
  print(f"âš ï¸ Labels omitidos: {missing_count}")
  SCRIPT_EOF
  
  python3 /tmp/generate_summary.py
  shell: /usr/bin/bash -e {0}
  env:
    RUN_STARTED_AT: 2025-11-18T00:09:12Z
    PRS_DATA: []
    PRS_COUNT: 0
    CHANGED: false
    COMMIT_SHA: 
    MISSING_COUNT: 6
    VALID_COUNT: 3
    ISSUE_URL: 
/tmp/generate_summary.py:229: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  timestamp = datetime.utcnow().strftime('%Y-%m-%d %H:%M UTC')
âœ… Summary generado correctamente
ğŸ“Š PRs detectados: 0
ğŸ“¦ Ecosistemas: 4
âœ… Labels vÃ¡lidos: 3
âš ï¸ Labels omitidos: 6